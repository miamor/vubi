function textAreaAdjust (o) {
	o.style.height = "1px";
	o.style.height = (3+o.scrollHeight)+"px";
}

function getCaret(el) { 
	if (el.selectionStart) { 
		return el.selectionStart; 
	} else if (document.selection) { 
		el.focus();
		var r = document.selection.createRange(); 
		if (r == null) { 
			return 0;
		}
		var re = el.createTextRange(), rc = re.duplicate();
		re.moveToBookmark(r.getBookmark());
		rc.setEndPoint('EndToStart', re);
		return rc.text.length;
	}  
	return 0; 
}

function rate (element) {
	if (!element) element = 'body';

	// share
	$(element).closest('.feed-one-item').find('.share').click(function () {
		$a = $(this);
		share_window = window.open('https://www.facebook.com/dialog/feed?'+$a.attr('data-param'), "mywindow","status=1,width=350,height=150");
		return false
	})
	
	if ($('#join').length) {
		if ($(this).attr('data-join') != 1) {
			$(element).remove();
		}
	}
	
	$(element).closest('.feed-one-item').find('.feed-main-content').children('div').each(function () {
		if (/^(?:\s|<br\ ?\/?>)*$/.test($(this).html())) {
			$(this).remove();
		}
	})

	$(element).find('.cmt-textarea').keyup(function (event) {
		textAreaAdjust(this);
		if (event.keyCode == 13) {
			var content = this.value;  
			var caret = getCaret(this);
			event.preventDefault();
			if (event.shiftKey) {
				this.value = content.substring(0, caret - 1) + "\n" + content.substring(caret, content.length);
				event.stopPropagation();
			} else {
				this.value = content.substring(0, caret - 1) + content.substring(caret, content.length);
				$(element).find('.cmt-textarea').attr('readonly', true);
				$(element).submit();
			}
			return false;  
		}
	}); 
	
	$(element).find(".rating-icons").not(".rated, .myrate").children(".rating-star-icon").hover(function() {
		a = $(this).attr("id");
		for (i = 1; i <= a; i++) {
			$(element).find(".rating-star-icon.v" + i).removeClass('fa-star-o').addClass('fa-star');
		}
	}).mouseout(function() {
		$(element).find(".rating-star-icon").each(function () {
			if (!$(this).is('.active')) $(this).removeClass('fa-star').addClass('fa-star-o');
		})
	}).click(function() {
		a = $(this).attr("id");
		$(element).find(".rate-val").val(a);
		$(element).find(".rating-star-icon").removeClass('active fa-star').addClass('fa-star-o');
		for (i = 1; i <= a; i++) {
			$(element).find(".rating-star-icon.v" + i).removeClass('fa-star-o').addClass('active fa-star');
		}
	});
/*	$(element).submit(function() {
		i = $(this).find(".star-info").attr("data-c");
		url = window.location.href;
		a = $(this).find(".rate-val").val();
//		$('[type="submit"]').attr("disabled", true);
//		alert(url + "&rate=" + a);
		$form = $(this);
		$form.children('*:visible').hide().addClass('visible hide-to-load');
		$form.append('<div class="spinner loading-sending"><div></div><div></div><div></div></div>');
		formData = getFormData($form);
		$.ajax({
			url: url + "?do=rate&rate=" + a,
			type: "POST",
			data: formData,
			datatype: "json",
			success: function (data) {
				alertsContent = data.split(/\[content\]|\[\/content]/)[1];
				alertsType = data.split(/\[type\]|\[\/type\]/)[1];
				alertsDataID = data.split(/\[dataID\]|\[\/dataID\]/)[1];
				$form.addClass('just-sent').children('.spinner.loading-sending').remove();
				$form.children('*.visible.hide-to-load').show().removeClass('visible hide-to-load');
				if (alertsContent) mtip('', alertsType, '', alertsContent);
				$('body').append(alertsContent);
				if (alertsType == 'success') {
					$form.parent().children(".ratings-list").load(url + "?v=window section#ratings .ratings-list > div");
					$form.slideUp(300).remove();
				}
			},
			error: function(e) {
				mtip("", "error", e.status, "Please try again or contact the administrators for help.")
			}
		});
		return false
	})*/
}
